---
title: 備份
author: appleboy
type: post
date: -001-11-30T00:00:00+00:00
draft: true
url: /?p=3145
categories:
  - blog

---
### phpfarm 簡介 不知道大家有沒有遇過在網路下載各大 PHP Open Source，例如 phpBB Gallery 等軟體，結果安裝到電腦上面，發現網頁開起來卻出現很多錯誤。看到這畫面，初學者一定會非常懊惱，也會對這軟體產生一些誤會，然而這些錯誤訊息是不是可以避免呢？當一位 PHP 開發工程師，就應該注意每個 PHP 版本之間的差異。例如，函式是否已經被官方移除&#8230;等。這些變化都會造成使用者遇到錯誤訊息，所以每次要 Release 新的軟體應該要針對所有 PHP 版本進行相容性的測試。底下有兩種方式可以解決問題: 

  * 使用不同台機器測試不同 PHP 版本
  * 在同一台機器上安裝多重 PHP 版本 第1種方式需要很多硬體資源和安裝時間，除此之外，在不同的機器上測試，必須佈署相同的測試工具，你應該不會想要用 ssh 分別連上 15 台機器安裝軟體吧。第2種的好處是顯而易見，相對來說，在一台機器上安裝所有不同 PHP 版本，是較為容易的作法，並且可一次解決軟體相依性的問題，執行跨版本的測試也比較容易。為解決上面單一機器多重 PHP 版本問題，筆者來介紹一套好用軟體: phpfarm，底下所介紹的指令及操作方式，都是在作業系統 Ubuntu 10.10 下所操作。 

### 透過 git 方式下載 $ git clone git://git.code.sf.net/p/phpfarm/code phpfarm $ cd phpfarm 簡單介紹 phpfarm 目錄架構，下載 phpfarm 檔案後，進入 phpfarm 目錄，會發現裡面有兩個目錄，分別是 inst 跟 src 目錄，inst 目錄會存放編譯過後的執行檔，而 src 存放編譯需要的 script 跟原始碼。 

### 簡易編譯方式 先介紹最簡單編譯方式，讓您可以馬上使用不同的 php command line 版本 $ cd phpfarm/src $ ./compile 5.3.2 當您執行 ./compile 5.3.2 (在此以5.3.2為例) 之後，script 會從 php.net 下載 5.3.2 原始檔 .tar.gz 下來編譯，如果編譯過程沒有發生任何錯誤，就可以到 ./inst/bin/ 底下看到 php-5.3.2 目錄及相關執行後的結果，我們可以透過底下指令看到結果 root@Ubuntu [/opt/phpfarm] ./inst/bin/php-5.3.2 -v PHP 5.3.2 (cli) (built: Oct 22 2011 18:38:53) (DEBUG) Copyright (c) 1997-2010 The PHP Group Zend Engine v2.3.0, Copyright (c) 1998-2010 Zend Technologies 如果要在任何地方都可以使用此 PHP 版本，必須增加環境變數。PHP 套件所有執行檔會放在 /opt/phpfarm/inst/bin 這個路徑，因此必須修改 $PATH 環境變數，使得能夠取代掉原本的 PHP 執行檔。注意，由於系統在尋找執行檔時，會依照PATH中的路徑依序尋找，且若系統中有多個相同檔名的執行檔，則以第一個找到的為所要執行的檔案，因此，必須將此路徑需加在最前面，才能夠避免系統先找尋到舊有的PHP執行檔，修改方式如下。 $ export PATH=/opt/phpfarm/inst/bin:$PATH 

### 進階編譯方式 上面介紹過簡易編譯方式，可是您會發現編譯好的 PHP，無法使用 mysql 任何相關函式庫，所以我們必須加上編譯參數 &#8211;with-mysql，才能支援mysql相關函式庫。該透過什麼方式才可以編譯進去呢? 官方網站似乎沒有類似的教學，實際上關鍵就在 src/compile.sh script 檔，當執行 ./compile 5.3.2 會先載入 default option 設定，此設定放置在 ./src/options.sh 裡面，編譯不同版本就需要不同的環境，因此需要新增不同版本的設定檔，例如要編譯 php 5.3.2 版本，會先建立 custom-options-5.3.2.sh 檔案，內容如下 configoptions=&#8221;\ &#8211;enable-bcmath \ &#8211;enable-calendar \ &#8211;enable-exif \ &#8211;enable-ftp \ &#8211;with-mysql \ &#8211;with-mysqli \ &#8211;enable-mbstring \ &#8211;enable-pcntl \ &#8211;enable-soap \ &#8211;enable-sockets \ &#8211;enable-sqlite-utf8 \ &#8211;enable-wddx \ &#8211;enable-zip \ &#8211;with-zlib \ &#8211;with-gettext \ 所以如果還要編譯不同版本，檔案架構如下 # 原始設定檔 $ custom-options.sh # PHP 5 設定檔 $ custom-options-5.sh # PHP 5.3 設定檔 $ custom-options-5.3.sh # PHP 5.3.1 設定檔 $ custom-options-5.3.1.sh 從上面可以看出 $configoptions 就是編譯設定環境變數，只要修改此變數，就可以編譯出不同功能的 PHP，接著執行 ./compile 5.3.2，你會發現此設定會覆蓋原本 default 設定值，假如編譯 MySQL 過程會遇到底下錯誤訊息 configure: error: Cannot find MySQL header files under yes. Note that the MySQL client library is not bundled anymore! 請額外安裝 MySQL Client Library 參考文獻 (http://ubuntuforums.org/showthread.php?t=637973) $ sudo apt-get install libmysqlclient15-dev 

### 在 Apache 上面執行不同 PHP 版本 透過上述方法完成安裝不同 PHP 的版本，那接下來，我們需要瞭解如何將眾多PHP版本整合到 Apache 設定呢？在看底下文章之前，建議先在 Ubuntu 安裝好基礎的 Apache + PHP + MySQL，避免有套件相依性問題尚未解決。我們可以透過底下3點來達成目的。 

  * 使用 mod\_php 及 mod\_fastcgi
  * 建立個別 PHP 版本的 CGI Server
  * 設定不同版本的 Virtual Host 來執行 底下依依介紹如何整合多套 PHP 版本到 Apache。 

### 安裝 FastCGI 在 Ubuntu 或 Debian 系統請用 apt-get 方式安裝 $ sudo apt-get install apache2.2-bin apache2.2-common apache2-mpm-worker libapache2-mod-fcgid libxml2-dev 安裝好之後，接著我們透過 a2enmod 指令將 fastcgi 啟動。 $ sudo a2enmod fastcgi $ sudo a2enmod actions 

### FastCGI 設定 啟動完 mod_fastcgi 之後，我們必須準備 FastCGI Server，打開 /etc/apache2/conf.d/php-cgisetup.conf，如果沒有此檔案，請先新增，將底下程式碼寫入到 php-cgisetup.conf FastCgiServer /var/www/cgi-bin/php-cgi-5.3.0 FastCgiServer /var/www/cgi-bin/php-cgi-5.3.1 FastCgiServer /var/www/cgi-bin/php-cgi-5.3.2 ScriptAlias /cgi-bin-php/ /var/www/cgi-bin/ 

### PHP-CGI 設定 根據我們上面步驟，共建立了3個 /var/www/cgi-bin/php-cgi-$version 檔案，請先改變檔案屬性為可執行並且將底下程式碼分別填入，以 5.3.2 為例 #!/bin/sh PHPRC=&#8221;/etc/php5/cgi/5.3.2/&#8221; export PHPRC PHP\_FCGI\_CHILDREN=3 export PHP\_FCGI\_CHILDREN PHP\_FCGI\_MAX\_REQUESTS=5000 expoty PHP\_FCGI\_MAX\_REQUESTS exec /opt/phpfarm/inst/bin/php-cgi-5.3.2 這邊請注意 PHPRC 此設定，請務必依照此設定建立一個空目錄。 

### 在 VirtualHost 設定單一PHP版本 完成上面動作之後，最後一個步驟就是設定 VirtualHost 部份，Ubuntu 底下的 Virtual Host 放置在 /etc/apache2/sites-available/ 目錄，我們先建立以 phpfarm 的 Virtual Host，裡面寫入底下程式碼: AddHandler php-cgi .php Action php-cgi /cgi-bin-php/php-cgi-5.3.2 Options Indexes FollowSymLinks MultiViews ExecCGI AllowOverride all Order allow,deny allow from all SetHandler php-cgi 存檔後，務必執行底下步驟，將 Virtual Host 啟動 $ sudo a2ensite phpfarm 假設今天要測試 5.3.2 版本，只要更動 Action php-cgi 此行設定即可。接著用 phpinfo() 來觀看 PHP 版本資訊吧。 底下是安裝完成圖 

<img class="alignnone" src="https://i1.wp.com/farm7.static.flickr.com/6059/6270752067_1d3a704274.jpg?resize=500%2C307&#038;ssl=1" alt="" data-recalc-dims="1" /> 

### 在 phpfarm 上安裝 PHP extensions 相信對於以上步驟都是非常容易且易懂的，但是， php 所提供的 extension 是不夠我們使用，那該如何透過其他方式將 extension 安裝到 phpfarm 所提供的 php 版本呢? 底下來一一介紹，我們以 Pecl-APC 模組來當作範例，安裝模組之前，先將 pear 套件安裝: $ sudo apt-get install php-pear 透過 pear 搜尋需要的套件，搜尋之前，請先 update pear channel $ sudo pear channel-update doc.php.net $ sudo pear channel-update pear.php.net $ sudo pear search -a apc pear 會依序 channel 地毯是搜尋 apc 套件，如果搜尋到，會顯示如下: Retrieving data&#8230;0% no packages found that match pattern &#8220;apc&#8221;, for channel doc.php.net. Retrieving data&#8230;0% no packages found that match pattern &#8220;apc&#8221;, for channel pear.php.net. Retrieving data&#8230;0% .Matched packages, channel pecl.php.net: ======================================= Package Stable/(Latest) Local APC 3.1.9 (stable) Alternative PHP Cache 接著透過 pear download 指令下載原始檔 $ sudo pear download pecl/APC downloading APC-3.1.9.tgz &#8230; Starting to download APC-3.1.9.tgz (155,540 bytes) &#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;&#8230;done: 155,540 bytes FileAPC-3.1.9.tgz downloaded $ sudo tar -zxvf APC-3.1.9.tgz 

### 安裝 extension 手動安裝 PHP extension 之前，先來介紹 phpize 指令是做什麼用的。 phpize 是屬於 php-devel 中的東西，主要是設定 php 外掛模組，所以安裝 php-devel 相關套件就會有 phpize 可以使用 (執行檔預設存放於 /usr/bin/phpize )。 如果透過 phpfarm 安裝 PHP 環境，phpize 則會被安裝到 /opt/phpfarm/inst/bin/phpize-$version，此外，要執行 phpize 之前，必須先安裝autoconf套件才能順利執行。 $ sudo aptitude install autoconf 安裝 APC extension $ cd APC-3.1.9 $ /opt/phpfarm/inst/bin/phpize-5.3.2 Configuring for: PHP Api Version: 20090626 Zend Module Api No: 20090626 Zend Extension Api No: 220090626 $ sudo ./configure &#8211;with-php-config=/opt/phpfarm/inst/bin/php-config-5.3.2 $ make && make install &#8230;&#8230; Installing shared extensions: /opt/phpfarm/inst/php-5.3.2/lib/php/extensions/debug-non-zts-20090626/ Installing header files: /opt/phpfarm/inst/php-5.3.2/include/php/ 上述安裝完畢之後，就會產生 apc.so，如果要啟動 extension，務必在 php.ini 加入底下 extension_dir=/opt/phpfarm/inst/php-5.3.2/lib/php/extensions/debug-non-zts-20090626 extension=apc.so php.ini 檔案可以用底下指令知道位置 $ /opt/phpfarm/inst/bin/php-5.3.2 &#8211;ini Configuration File (php.ini) Path: /opt/phpfarm/inst/php-5.3.2/lib Loaded Configuration File: /opt/phpfarm/inst/php-5.3.2/lib/php.ini 

### 結論 對於在寫大型 Open source project 開發者來說，這真的是一大福音，畢竟好用的軟體，必須相容在各 PHP 版本，並且解決相依性問題，所以安裝多重版本在單一台電腦可以省下很多測試時間。