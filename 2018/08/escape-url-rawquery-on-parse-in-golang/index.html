<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>在 Go 語言內的 URL RawQuery 的改變 - 小惡魔 - AppleBOY</title><meta name=description content="更新 (2018.08.29) 感謝中國網友幫忙發個 Issue，大家有空可以關注看看，等官方怎麼回應

Go 語言內的 net/url 函式庫讓開發者可以簡單的 Parse 指定的 URL，最近 Google 上了這個 Patch，這個 Patch 讓原本的 RawQuery 值產生了變化，原先沒有驗證 RawQuery 是否包含了不合法的字元，現在只要 RawQuesy 內含有任意的不合法字元，就會直接被 QueryEscape 函式轉換，這個 Patch 不影響這次 Go 1.11 版本，會影響的是明年 2019 年釋出的 Go 1.12 版本，但是大家都知道在 GitHub 上面有在寫測試的話，都會在 Travis 內加入 master 版本當作驗證，如果有用到 RawQuery 的話，肯定會遇到這問題，底下來描述為什麼會出現這問題。"><meta name=author content="Appleboy"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"小惡魔 - AppleBOY","url":"https:\/\/blog.wu-boy.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/blog.wu-boy.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/blog.wu-boy.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/blog.wu-boy.com\/2018\/08\/escape-url-rawquery-on-parse-in-golang\/","name":"在 go 語言內的 URL raw query 的改變"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"appleboy"},"headline":"在 Go 語言內的 URL RawQuery 的改變","description":"更新 (2018.08.29) 感謝中國網友幫忙發個 Issue，大家有空可以關注看看，等官方怎麼回應\n\nGo 語言內的 net\/url 函式庫讓開發者可以簡單的 Parse 指定的 URL，最近 Google 上了這個 Patch，這個 Patch 讓原本的 RawQuery 值產生了變化，原先沒有驗證 RawQuery 是否包含了不合法的字元，現在只要 RawQuesy 內含有任意的不合法字元，就會直接被 QueryEscape 函式轉換，這個 Patch 不影響這次 Go 1.11 版本，會影響的是明年 2019 年釋出的 Go 1.12 版本，但是大家都知道在 GitHub 上面有在寫測試的話，都會在 Travis 內加入 master 版本當作驗證，如果有用到 RawQuery 的話，肯定會遇到這問題，底下來描述為什麼會出現這問題。\n","inLanguage":"en","wordCount":367,"datePublished":"2018-08-27T06:00:56","dateModified":"2018-08-27T06:00:56","image":"https:\/\/lh3.googleusercontent.com\/Kq9CxHZWopKj__EgF_BpzLv8FhwvDkc0iacrl9V5IJjpr-dZ7Y5O-Vc1i9FhGQ8gHTdKeBisG_1ie1IONQXmK0a3myyl_BNouP76CLHGHRzsPPRgRF3RiKYqOkdS86mZOIu7KYFTUio=w1920-h1080","keywords":["golang"],"mainEntityOfPage":"https:\/\/blog.wu-boy.com\/2018\/08\/escape-url-rawquery-on-parse-in-golang\/","publisher":{"@type":"Organization","name":"https:\/\/blog.wu-boy.com","logo":{"@type":"ImageObject","url":"https:\/\/lh3.googleusercontent.com\/Kq9CxHZWopKj__EgF_BpzLv8FhwvDkc0iacrl9V5IJjpr-dZ7Y5O-Vc1i9FhGQ8gHTdKeBisG_1ie1IONQXmK0a3myyl_BNouP76CLHGHRzsPPRgRF3RiKYqOkdS86mZOIu7KYFTUio=w1920-h1080","height":60,"width":60}}}</script><meta property="og:title" content="在 Go 語言內的 URL RawQuery 的改變"><meta property="og:description" content="更新 (2018.08.29) 感謝中國網友幫忙發個 Issue，大家有空可以關注看看，等官方怎麼回應

Go 語言內的 net/url 函式庫讓開發者可以簡單的 Parse 指定的 URL，最近 Google 上了這個 Patch，這個 Patch 讓原本的 RawQuery 值產生了變化，原先沒有驗證 RawQuery 是否包含了不合法的字元，現在只要 RawQuesy 內含有任意的不合法字元，就會直接被 QueryEscape 函式轉換，這個 Patch 不影響這次 Go 1.11 版本，會影響的是明年 2019 年釋出的 Go 1.12 版本，但是大家都知道在 GitHub 上面有在寫測試的話，都會在 Travis 內加入 master 版本當作驗證，如果有用到 RawQuery 的話，肯定會遇到這問題，底下來描述為什麼會出現這問題。"><meta property="og:image" content="https://lh3.googleusercontent.com/jsocHCR9A9yEfDVUTrU0m42_aHhTEVDGW5p5PsQSx7GSlkt3gLjohfXH3S7P7p982332ruU_e-EtW0LwmiuZjvN65VIcyME-zE35C6EM0IV1nqY6KoNw3dwW2djjid3F-T5YgnJothA=w1920-h1080"><meta property="og:url" content="https://blog.wu-boy.com/2018/08/escape-url-rawquery-on-parse-in-golang/"><meta property="og:type" content="website"><meta property="og:site_name" content="小惡魔 - AppleBOY"><meta name=twitter:title content="在 Go 語言內的 URL RawQuery 的改變"><meta name=twitter:description content="更新 (2018.08.29) 感謝中國網友幫忙發個 Issue，大家有空可以關注看看，等官方怎麼回應

Go 語言內的 net/url 函式庫讓開發者可以簡單的 Parse 指定的 URL，最近 Google 上了這個 Patch，這個 Patch 讓原本的 RawQuery 值產生了變化，原先沒有驗證 RawQuery 是否包含了不合法的字元，現在只要 RawQuesy 內含有任意的不合法字 …"><meta name=twitter:image content="https://lh3.googleusercontent.com/Kq9CxHZWopKj__EgF_BpzLv8FhwvDkc0iacrl9V5IJjpr-dZ7Y5O-Vc1i9FhGQ8gHTdKeBisG_1ie1IONQXmK0a3myyl_BNouP76CLHGHRzsPPRgRF3RiKYqOkdS86mZOIu7KYFTUio=w1920-h1080"><meta name=twitter:card content="summary"><meta name=twitter:site content="@appleboy"><meta name=twitter:creator content="@appleboy"><link href=https://i.imgur.com/PpOg8Dz.jpg rel=icon type=image/x-icon><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css><link rel=stylesheet href=https://blog.wu-boy.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://blog.wu-boy.com/css/syntax.css><link rel=stylesheet href=https://blog.wu-boy.com/css/codeblock.css><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-5766319-6','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://blog.wu-boy.com>小惡魔 - AppleBOY</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title="Youtube 頻道" href=http://bit.ly/youtube-boy><i class="fab fa-youtube"></i> Youtube 頻道</a></li><li class=navlinks-container><a class=navlinks-parent><i class="fas fa-video"></i> 線上課程</a><div class=navlinks-children><a href=/golang-online-course/>Go 語言基礎實戰</a>
<a href=/docker-course/>Docker 容器開發實戰</a>
<a href=/drone-devops/>一天學會 DevOps 自動化流程</a></div></li><li><a title=歷年文章 href=/archives/><i class="fas fa-sitemap fa-lg"></i> 歷年文章</a></li><li><a href=#modalSearch data-toggle=modal data-target=#modalSearch style=outline:none><span class="hidden-sm hidden-md hidden-lg">Search</span> <span id=searchGlyph class="glyphicon glyphicon-search"></span></a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="小惡魔 - AppleBOY" href=https://blog.wu-boy.com><img class=avatar-img src="https://lh3.googleusercontent.com/Kq9CxHZWopKj__EgF_BpzLv8FhwvDkc0iacrl9V5IJjpr-dZ7Y5O-Vc1i9FhGQ8gHTdKeBisG_1ie1IONQXmK0a3myyl_BNouP76CLHGHRzsPPRgRF3RiKYqOkdS86mZOIu7KYFTUio=w1920-h1080" alt="小惡魔 - AppleBOY"></a></div></div></div></nav><div id=modalSearch class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><button type=button class=close data-dismiss=modal>&#215;</button><h4 class=modal-title>Search 小惡魔 - AppleBOY</h4></div><div class=modal-body><gcse:search></gcse:search></div><div class=modal-footer><button type=button class="btn btn-default" data-dismiss=modal>Close</button></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-md-10 col-md-offset-1"><div class=post-heading><h1>在 Go 語言內的 URL RawQuery 的改變</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on August 27, 2018
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;2&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;367&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;appleboy</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-md-10 col-md-offset-1"><aside class=toc-article><nav id=TableOfContents><ul><li><ul><li><a href=#rawquery-含有不合法字元>RawQuery 含有不合法字元</a></li><li><a href=#如何修正>如何修正</a></li><li><a href=#後記>後記</a></li></ul></li></ul></nav></aside><article role=main class=blog-post><p><strong>更新 (2018.08.29) 感謝中國網友幫忙發個 <a href=https://github.com/golang/go/issues/27302>Issue</a>，大家有空可以關注看看，等官方怎麼回應</strong></p><p><a href="https://lh3.googleusercontent.com/jsocHCR9A9yEfDVUTrU0m42_aHhTEVDGW5p5PsQSx7GSlkt3gLjohfXH3S7P7p982332ruU_e-EtW0LwmiuZjvN65VIcyME-zE35C6EM0IV1nqY6KoNw3dwW2djjid3F-T5YgnJothA=w1920-h1080"><img src="https://lh3.googleusercontent.com/jsocHCR9A9yEfDVUTrU0m42_aHhTEVDGW5p5PsQSx7GSlkt3gLjohfXH3S7P7p982332ruU_e-EtW0LwmiuZjvN65VIcyME-zE35C6EM0IV1nqY6KoNw3dwW2djjid3F-T5YgnJothA=w1920-h1080" alt></a></p><p><a href=https://golang.org/>Go 語言</a>內的 <code>net/url</code> 函式庫讓開發者可以簡單的 Parse 指定的 URL，最近 Google 上了這個 <a href=https://github.com/golang/go/commit/1040626c0ce4a1bc2b312aa0866ffeb2ff53c1ab>Patch</a>，這個 Patch 讓原本的 RawQuery 值產生了變化，原先沒有驗證 RawQuery 是否包含了不合法的字元，現在只要 RawQuesy 內含有任意的不合法字元，就會直接被 <code>QueryEscape</code> 函式轉換，這個 Patch 不影響這次 <a href=https://blog.golang.org/go1.11>Go 1.11 版本</a>，會影響的是明年 2019 年釋出的 Go 1.12 版本，但是大家都知道在 <a href=https://github.com>GitHub</a> 上面有在寫測試的話，都會在 <a href=https://travis-ci.org>Travis</a> 內加入 <code>master</code> 版本當作驗證，如果有用到 RawQuery 的話，肯定會遇到這問題，底下來描述為什麼會出現這問題。</p><h2 id=rawquery-含有不合法字元>RawQuery 含有不合法字元</h2><p>首先來看看在 Go 1.11 版本時本來應該輸出什麼，請直接線上看<a href=https://play.golang.org/p/ZvZ-SoUjK16>例子</a>。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#8b008b;font-weight:700>package</span> main

<span style=color:#8b008b;font-weight:700>import</span> (
	<span style=color:#cd5555>&#34;log&#34;</span>
	<span style=color:#cd5555>&#34;net/url&#34;</span>
)

<span style=color:#8b008b;font-weight:700>func</span> <span style=color:#008b45>main</span>() {
	u, err := url.<span style=color:#008b45>Parse</span>(<span style=color:#cd5555>&#34;http://bing.com/search?k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span>)
	<span style=color:#8b008b;font-weight:700>if</span> err != <span style=color:#8b008b;font-weight:700>nil</span> {
		log.<span style=color:#008b45>Fatal</span>(err)
	}

	<span style=color:#8b008b;font-weight:700>if</span> u.RawQuery != <span style=color:#cd5555>&#34;k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span> {
		log.<span style=color:#008b45>Fatal</span>(<span style=color:#cd5555>&#34;RawQuery error&#34;</span>)
	}

	log.<span style=color:#008b45>Printf</span>(<span style=color:#cd5555>&#34;%#v&#34;</span>, u.<span style=color:#008b45>Query</span>())
}
</code></pre></td></tr></table></div></div><p>在 Go 1.11 以前，你會直接看到底下輸出:</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go>url.Values{<span style=color:#cd5555>&#34;k&#34;</span>:[]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;v&#34;</span>}, <span style=color:#cd5555>&#34;id&#34;</span>:[]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;main&#34;</span>, <span style=color:#cd5555>&#34;omit&#34;</span>}, <span style=color:#cd5555>&#34;array[]&#34;</span>:[]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;first&#34;</span>, <span style=color:#cd5555>&#34;second&#34;</span>}, <span style=color:#cd5555>&#34;ids[i]&#34;</span>:[]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;111&#34;</span>}, <span style=color:#cd5555>&#34;ids[j]&#34;</span>:[]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;3.14&#34;</span>}}
</code></pre></td></tr></table></div></div><p><a href=https://golang.org/pkg/net/url/>url 函式庫</a>幫忙把 RawQuery 整理成 map[string][]string 格式，所以在 URL 內可以直接 Parse <code>array[]=first&array[]=second</code> 多個 Array 值。這個預設行為在最新的 Go 語言被換掉了，現在執行 <code>u.Query()</code> 你會看到變成底下，整串的 Raw Query String 被當長一個 Key 值了。</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go>url.Values{<span style=color:#cd5555>&#34;k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span>: []<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;&#34;</span>}}
</code></pre></td></tr></table></div></div><p>這就是最大的改變，造成在 Travis 執行錯誤。</p><h2 id=如何修正>如何修正</h2><p>修正方式其實很簡單，自己在寫個小型 Parser 把原本的格式在轉換就好，請參考<a href=https://play.golang.org/p/wO9vR3Ylliq>線上解法</a></p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1> 1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2> 2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3> 3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4> 4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5> 5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6> 6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7> 7</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=8><a style=outline:none;text-decoration:none;color:inherit href=#8> 8</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=9><a style=outline:none;text-decoration:none;color:inherit href=#9> 9</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=10><a style=outline:none;text-decoration:none;color:inherit href=#10>10</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=11><a style=outline:none;text-decoration:none;color:inherit href=#11>11</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=12><a style=outline:none;text-decoration:none;color:inherit href=#12>12</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=13><a style=outline:none;text-decoration:none;color:inherit href=#13>13</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=14><a style=outline:none;text-decoration:none;color:inherit href=#14>14</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=15><a style=outline:none;text-decoration:none;color:inherit href=#15>15</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=16><a style=outline:none;text-decoration:none;color:inherit href=#16>16</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=17><a style=outline:none;text-decoration:none;color:inherit href=#17>17</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=18><a style=outline:none;text-decoration:none;color:inherit href=#18>18</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=19><a style=outline:none;text-decoration:none;color:inherit href=#19>19</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=20><a style=outline:none;text-decoration:none;color:inherit href=#20>20</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=21><a style=outline:none;text-decoration:none;color:inherit href=#21>21</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=22><a style=outline:none;text-decoration:none;color:inherit href=#22>22</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=23><a style=outline:none;text-decoration:none;color:inherit href=#23>23</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=24><a style=outline:none;text-decoration:none;color:inherit href=#24>24</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=25><a style=outline:none;text-decoration:none;color:inherit href=#25>25</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=26><a style=outline:none;text-decoration:none;color:inherit href=#26>26</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=27><a style=outline:none;text-decoration:none;color:inherit href=#27>27</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=28><a style=outline:none;text-decoration:none;color:inherit href=#28>28</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=29><a style=outline:none;text-decoration:none;color:inherit href=#29>29</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=30><a style=outline:none;text-decoration:none;color:inherit href=#30>30</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=31><a style=outline:none;text-decoration:none;color:inherit href=#31>31</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=32><a style=outline:none;text-decoration:none;color:inherit href=#32>32</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=33><a style=outline:none;text-decoration:none;color:inherit href=#33>33</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=34><a style=outline:none;text-decoration:none;color:inherit href=#34>34</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=35><a style=outline:none;text-decoration:none;color:inherit href=#35>35</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=36><a style=outline:none;text-decoration:none;color:inherit href=#36>36</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=37><a style=outline:none;text-decoration:none;color:inherit href=#37>37</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=38><a style=outline:none;text-decoration:none;color:inherit href=#38>38</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=39><a style=outline:none;text-decoration:none;color:inherit href=#39>39</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#8b008b;font-weight:700>package</span> main

<span style=color:#8b008b;font-weight:700>import</span> (
	<span style=color:#cd5555>&#34;log&#34;</span>
	<span style=color:#cd5555>&#34;net/url&#34;</span>
	<span style=color:#cd5555>&#34;strings&#34;</span>
)

<span style=color:#8b008b;font-weight:700>func</span> <span style=color:#008b45>main</span>() {
	u, err := url.<span style=color:#008b45>Parse</span>(<span style=color:#cd5555>&#34;http://bing.com/search?k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span>)
	<span style=color:#8b008b;font-weight:700>if</span> err != <span style=color:#8b008b;font-weight:700>nil</span> {
		log.<span style=color:#008b45>Fatal</span>(err)
	}

	<span style=color:#8b008b;font-weight:700>if</span> u.RawQuery != <span style=color:#cd5555>&#34;k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span> {
		log.<span style=color:#008b45>Fatal</span>(<span style=color:#cd5555>&#34;RawQuery error&#34;</span>)
	}

	log.<span style=color:#008b45>Printf</span>(<span style=color:#cd5555>&#34;%#v&#34;</span>, u.<span style=color:#008b45>Query</span>())

	query := <span style=color:#008b45>resetQuery</span>(<span style=color:#8b008b;font-weight:700>map</span>[<span style=color:#00688b;font-weight:700>string</span>][]<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;k=v&amp;id=main&amp;id=omit&amp;array[]=first&amp;array[]=second&amp;ids[i]=111&amp;ids[j]=3.14&#34;</span>: []<span style=color:#00688b;font-weight:700>string</span>{<span style=color:#cd5555>&#34;&#34;</span>}})
	log.<span style=color:#008b45>Printf</span>(<span style=color:#cd5555>&#34;%#v&#34;</span>, query)
}

<span style=color:#8b008b;font-weight:700>func</span> <span style=color:#008b45>resetQuery</span>(m <span style=color:#8b008b;font-weight:700>map</span>[<span style=color:#00688b;font-weight:700>string</span>][]<span style=color:#00688b;font-weight:700>string</span>) <span style=color:#8b008b;font-weight:700>map</span>[<span style=color:#00688b;font-weight:700>string</span>][]<span style=color:#00688b;font-weight:700>string</span> {
	dicts := <span style=color:#658b00>make</span>(<span style=color:#8b008b;font-weight:700>map</span>[<span style=color:#00688b;font-weight:700>string</span>][]<span style=color:#00688b;font-weight:700>string</span>)
	<span style=color:#8b008b;font-weight:700>for</span> k, v := <span style=color:#8b008b;font-weight:700>range</span> m {
		lists := strings.<span style=color:#008b45>Split</span>(k, <span style=color:#cd5555>&#34;&amp;&#34;</span>)
		<span style=color:#8b008b;font-weight:700>if</span> <span style=color:#658b00>len</span>(lists) == <span style=color:#b452cd>1</span> {
			dicts[k] = v
			<span style=color:#8b008b;font-weight:700>continue</span>
		}
		<span style=color:#8b008b;font-weight:700>for</span> _, vv := <span style=color:#8b008b;font-weight:700>range</span> lists {
			p := strings.<span style=color:#008b45>Split</span>(vv, <span style=color:#cd5555>&#34;=&#34;</span>)
			dicts[p[<span style=color:#b452cd>0</span>]] = <span style=color:#658b00>append</span>(dicts[p[<span style=color:#b452cd>0</span>]], p[<span style=color:#b452cd>1</span>])
		}
	}
	<span style=color:#8b008b;font-weight:700>return</span> dicts
}
</code></pre></td></tr></table></div></div><p>只要 RawQuery 裡面有包含底下字元，就會被 escape 掉</p><div class=highlight><div style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=1><a style=outline:none;text-decoration:none;color:inherit href=#1>1</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=2><a style=outline:none;text-decoration:none;color:inherit href=#2>2</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=3><a style=outline:none;text-decoration:none;color:inherit href=#3>3</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=4><a style=outline:none;text-decoration:none;color:inherit href=#4>4</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=5><a style=outline:none;text-decoration:none;color:inherit href=#5>5</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=6><a style=outline:none;text-decoration:none;color:inherit href=#6>6</a>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=7><a style=outline:none;text-decoration:none;color:inherit href=#7>7</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#eed;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>// validQuery reports whether s is a valid query string per RFC <span style=color:#b452cd>3986</span>
// Section 3.4:
//     <span style=color:#00688b>query</span>       = *( pchar / <span style=color:#cd5555>&#34;/&#34;</span> / <span style=color:#cd5555>&#34;?&#34;</span> )
//     <span style=color:#00688b>pchar</span>       = unreserved / pct-encoded / sub-delims / <span style=color:#cd5555>&#34;:&#34;</span> / <span style=color:#cd5555>&#34;@&#34;</span>
//     <span style=color:#00688b>unreserved</span>  = ALPHA / DIGIT / <span style=color:#cd5555>&#34;-&#34;</span> / <span style=color:#cd5555>&#34;.&#34;</span> / <span style=color:#cd5555>&#34;_&#34;</span> / <span style=color:#cd5555>&#34;~&#34;</span>
//     sub-delims  = <span style=color:#cd5555>&#34;!&#34;</span> / <span style=color:#cd5555>&#34;</span>$<span style=color:#cd5555>&#34;</span> / <span style=color:#cd5555>&#34;&amp;&#34;</span> / <span style=color:#cd5555>&#34;&#39;&#34;</span> / <span style=color:#cd5555>&#34;(&#34;</span> / <span style=color:#cd5555>&#34;)&#34;</span>
//                   / <span style=color:#cd5555>&#34;*&#34;</span> / <span style=color:#cd5555>&#34;+&#34;</span> / <span style=color:#cd5555>&#34;,&#34;</span> / <span style=color:#cd5555>&#34;;&#34;</span> / <span style=color:#cd5555>&#34;=&#34;</span>
</code></pre></td></tr></table></div></div><h2 id=後記>後記</h2><p>現在含以前的版本都不會遇到這問題，如果你有用一些 Framework 請務必在明年釋出下一版後，一起跟著升級，<a href=https://github.com/gin-gonic/gin>Gin</a> 現在已經發 <a href=https://github.com/gin-gonic/gin/pull/1510>Patch</a> 修正了。</p><div class=blog-tags><a href=https://blog.wu-boy.com/tags/golang/>golang</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f&text=%e5%9c%a8%20Go%20%e8%aa%9e%e8%a8%80%e5%85%a7%e7%9a%84%20URL%20RawQuery%20%e7%9a%84%e6%94%b9%e8%ae%8a&via=appleboy" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f&title=%e5%9c%a8%20Go%20%e8%aa%9e%e8%a8%80%e5%85%a7%e7%9a%84%20URL%20RawQuery%20%e7%9a%84%e6%94%b9%e8%ae%8a" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f&title=%e5%9c%a8%20Go%20%e8%aa%9e%e8%a8%80%e5%85%a7%e7%9a%84%20URL%20RawQuery%20%e7%9a%84%e6%94%b9%e8%ae%8a" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f&title=%e5%9c%a8%20Go%20%e8%aa%9e%e8%a8%80%e5%85%a7%e7%9a%84%20URL%20RawQuery%20%e7%9a%84%e6%94%b9%e8%ae%8a" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fblog.wu-boy.com%2f2018%2f08%2fescape-url-rawquery-on-parse-in-golang%2f&description=%e5%9c%a8%20Go%20%e8%aa%9e%e8%a8%80%e5%85%a7%e7%9a%84%20URL%20RawQuery%20%e7%9a%84%e6%94%b9%e8%ae%8a" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/2021/05/migrate-wordpress-to-hugo/>將部落格從 Wordpress 轉換到 Hugo</a></li><li><a href=/2021/05/graceful-shutdown-with-progress-bar-in-golang/>如何取得上傳進度條 progress bar 相關數據及實作 Graceful Shutdown</a></li><li><a href=/2021/05/comunicate-with-open-policy-agent-using-resful-api/>使用 RESTful API 串接 Open Policy Agent</a></li><li><a href=/2021/04/setup-rbac-role-based-access-control-using-open-policy-agent/>初探 Open Policy Agent 實作 RBAC (Role-based access control) 權限控管</a></li><li><a href=/2021/03/debug-performance-issues-using-pyroscope/>即時效能分析工具 Pyroscope</a></li><li><a href=/2021/02/share-files-between-two-computer-using-croc-tool/>兩台電腦透過 croc 工具來傳送檔案 (簡單, 加密, 快速)</a></li><li><a href=/2021/02/upload-static-content-to-aws-s3-using-pulumi-02/>初探 Pulumi 上傳靜態網站到 AWS S3 (二)</a></li><li><a href=/2021/02/upload-static-content-to-aws-s3-using-pulumi-01/>初探 Pulumi 上傳靜態網站到 AWS S3 (一)</a></li><li><a href=/2021/02/graphql-gateway-in-golang/>使用 GraphQL Gateway 串接多個 Data Schema</a></li><li><a href=/2020/12/write-the-simple-cli-tool-in-golang/>用 Go 語言撰寫簡單的 Command Line 工具</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://blog.wu-boy.com/2018/07/drone-with-hashicorp-packer/ data-toggle=tooltip data-placement=top title="用 Drone CI/CD 整合 Packer 自動產生 GCP 或 AWS 映像檔">&larr; Previous Post</a></li><li class=next><a href=https://blog.wu-boy.com/2018/09/converting-timestamp-to-timestamp-in-a-specific-time-zone-in-postgres/ data-toggle=tooltip data-placement=top title="在 PostgreSQL 時區轉換及計算時間">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://blog.wu-boy.com/2018/08/escape-url-rawquery-on-parse-in-golang>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url='https://blog.wu-boy.com/2018/08/escape-url-rawquery-on-parse-in-golang'}</script></div></div></div></div><footer class=post-footer><div class=container><div class=row><div class="col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:appleboy.tw@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.facebook.com/appleboy46 title=Facebook><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/appleboy title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/appleboy title=GitLab><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://bitbucket.org/appleboy title=Bitbucket><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-bitbucket fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/appleboy title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/appleboy title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.youtube.com/channel/UCLCZJ9d_I7UJP2bpXpge8KA title=Youtube><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-youtube fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://blog.wu-boy.com>Appleboy</a>
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://blog.wu-boy.com>小惡魔 - AppleBOY</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.83.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://blog.wu-boy.com/js/main.js></script><script>(function(){var c='003841896160749976666:l9i5hqttpqi',a=document.createElement('script'),b;a.type='text/javascript',a.async=!0,a.src='https://cse.google.com/cse.js?cx='+c,b=document.getElementsByTagName('script')[0],b.parentNode.insertBefore(a,b)})()</script><script type=text/javascript>$(function(){$('#show-comments').on('click',function(){var a='appleboy48';(function(){var b=document.createElement('script');b.type='text/javascript',b.async=!0,b.src='//'+a+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(b)})(),$(this).hide()})})</script><script id=dsq-count-scr src=//appleboy48.disqus.com/count.js async></script><div class=back-to-top id=back-to-top><i class="fas fa-angle-double-up"></i></div></body></html>